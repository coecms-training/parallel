
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Batch Scripts &#8212; Parallel Programming in Climate and Weather</title>
    
  <link href="_static/css/theme.css" rel="stylesheet" />
  <link href="_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/sphinx-book-theme.acff12b8f9c144ce68a297486a2fa670.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="_static/js/index.1c5a1a01449ed65a7b51.js">

    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/togglebutton.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Converting a function from 1D to ND - slice method" href="case-studies/oned_to_nd_rewrite.html" />
    <link rel="prev" title="Measuring Performance" href="case-studies/read_speed.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="index.html">
      
      
      <h1 class="site-logo" id="site-title">Parallel Programming in Climate and Weather</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="README.html">
   Front Matter
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Concepts
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="concepts-intro.html">
   Introduction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="concepts-types.html">
   Types of parallelism
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="design-patterns.html">
   Design Patterns
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Dask
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="dask-intro.html">
   Introduction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="dask-performance.html">
   Performance
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="dask-troubleshooting.html">
   Pathological Behaviour and Troubleshooting
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="case-studies/read_speed.html">
   Measuring Performance
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Batch Scripts
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Case Studies
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="case-studies/oned_to_nd_rewrite.html">
   Converting a function from 1D to ND - slice method
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="case-studies/oned_to_nd.html">
   Converting a function from 1D to ND - apply_along_axis
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="case-studies/loading_ensemble.html">
   Loading Ensemble Members
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="case-studies/climatology_multivar.html">
   Monthly Climatology of Many Variables
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="case-studies/regridding.html">
   Regridding with xesmf
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="_sources/dask-batch.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/coecms-training/parallel"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/coecms-training/parallel/master?urlpath=tree/dask-batch.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#job-scripts">
   Job Scripts
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#dask-clients">
   Dask Clients
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#checking-on-batch-jobs">
   Checking on batch jobs
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#example">
   Example
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="batch-scripts">
<h1>Batch Scripts<a class="headerlink" href="#batch-scripts" title="Permalink to this headline">¶</a></h1>
<p>When you’re processing a large amount of data its a good idea to first test your analysis in an interactive job (e.g. using Jupyter) where you can refine your code quickly. Once you’ve got everything ready you can then move to a batch job and submit to the queue.</p>
<p>Batch jobs are submitted to the queue with a special program, Gadi uses <code class="docutils literal notranslate"><span class="pre">qsub</span></code>. The jobs are put into a queue alongside everyone else’s jobs on the supercomputer, and the jobs get selected from the queue and run when there are free cpus on the supercomputer based on a number of priority factors - job size, walltime request, amount of time your project has used already etc.</p>
<div class="section" id="job-scripts">
<h2>Job Scripts<a class="headerlink" href="#job-scripts" title="Permalink to this headline">¶</a></h2>
<p>A job script is a bash shell script. It lists the resources needed by the job, does any setup like loading modules, then runs your program:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1">#PBS -l ncpus=4</span>
<span class="c1">#PBS -l mem=16gb</span>
<span class="c1">#PBS -l walltime=1:00:00</span>
<span class="c1">#PBS -l jobfs=100gb</span>
<span class="c1">#PBS -l storage=gdata/hh5</span>
<span class="c1">#PBS -l wd</span>
<span class="c1">#PBS -j oe</span>
<span class="c1">#PBS -W umask=0022</span>

module use /g/data/hh5/public/modules
module load conda/analysis3

python ./myscript.py
</pre></div>
</div>
<p>You can run any type of program here, but you should make sure that there’s some sort of parallelisation enabled in it if you request more than one CPU. This could be from a model using MPI, in which case you’d run it with <code class="docutils literal notranslate"><span class="pre">mpirun</span> <span class="pre">PROGRAM</span></code>, or a Python script using either Dask or <code class="docutils literal notranslate"><span class="pre">multiprocessing</span></code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code class="docutils literal notranslate"><span class="pre">#PBS</span></code> lines need to be at the start of the file, right after <code class="docutils literal notranslate"><span class="pre">#!/bin/bash</span></code>.</p>
</div>
</div>
<div class="section" id="dask-clients">
<h2>Dask Clients<a class="headerlink" href="#dask-clients" title="Permalink to this headline">¶</a></h2>
<p>To enable Dask to use the resources requested by the run script you should start a Dask client. The simple way to do this on Gadi is to use <code class="docutils literal notranslate"><span class="pre">climtas.nci.GadiClient()</span></code>. Note that when you’re using Dask (or <code class="docutils literal notranslate"><span class="pre">multiprocessing</span></code>) you need to put your entire script inside a <code class="docutils literal notranslate"><span class="pre">if</span> <span class="pre">__name__</span> <span class="pre">==</span> <span class="pre">'__main__'</span></code> check:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">climtas.nci</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">climtas</span><span class="o">.</span><span class="n">nci</span><span class="o">.</span><span class="n">GadiClient</span><span class="p">()</span>
    
    <span class="c1"># Rest of your script runs inside the &#39;if&#39; check</span>
    <span class="c1"># ...</span>
</pre></div>
</div>
<p>The climtas function is a shortcut to starting a Dask client manually with the resources available to the queued job:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">dask.distributed</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">dask</span><span class="o">.</span><span class="n">distributed</span><span class="o">.</span><span class="n">Client</span><span class="p">(</span>
        <span class="n">n_workers</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PBS_NCPUS&#39;</span><span class="p">]),</span>
        <span class="n">memory_limit</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PBS_VMEM&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PBS_NCPUS&#39;</span><span class="p">]),</span>
        <span class="n">local_directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PBS_JOBFS&#39;</span><span class="p">],</span> <span class="s1">&#39;dask-worker-space&#39;</span><span class="p">)</span>
    <span class="p">)</span>
    
    <span class="c1"># Rest of your script runs inside the &#39;if&#39; check</span>
    <span class="c1"># ...</span>
</pre></div>
</div>
<p>It’s important to set the memory limit, as the queue system will automatically kill your job if it uses more memory than it has requested. If you don’t set the local directory then Dask will store temporary files in the current directory. For a large analysis these files can become quite large - putting them on the jobfs disk means they get cleaned up automatically when the job finishes.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This way of starting a Dask cluster only works on a single compute node, so if you’re using Gadi’s normal queue you can’t use more than 48 CPUs. It’s possible to set Dask up to use more than one node, but check how well your problem scales with increasing numbers of CPUs first.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you’re using the jobfs disk on Gadi, make sure your run script has a <code class="docutils literal notranslate"><span class="pre">#PBS</span> <span class="pre">-l</span> <span class="pre">jobfs</span></code> resource request</p>
</div>
</div>
<div class="section" id="checking-on-batch-jobs">
<h2>Checking on batch jobs<a class="headerlink" href="#checking-on-batch-jobs" title="Permalink to this headline">¶</a></h2>
<p>When you submit a job with <code class="docutils literal notranslate"><span class="pre">qsub</span></code> you’ll get a job ID number from the queue system. This ID number can be used to stop the job running if needed, with <code class="docutils literal notranslate"><span class="pre">qdel</span> <span class="pre">JOB_ID</span></code>.</p>
<p>You can check on the status of your jobs with <code class="docutils literal notranslate"><span class="pre">qstat</span></code>. On Gadi, the script <code class="docutils literal notranslate"><span class="pre">/g/data/hh5/public/apps/nci_scripts/uqstat</span></code> shows extended information about a job, including how much of its CPU and memory request it is using.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>                  <span class="n">project</span>    <span class="n">user</span>         <span class="n">name</span>     <span class="n">queue</span> <span class="n">state</span>  <span class="n">ncpus</span>        <span class="n">walltime</span> <span class="n">su</span> <span class="n">mem_pct</span> <span class="n">cpu_pct</span>           <span class="n">qtime</span>
<span class="mf">21672958.</span><span class="n">gadi</span><span class="o">-</span><span class="n">pbs</span>     <span class="n">w35</span>  <span class="n">saw562</span>  <span class="n">jupyter</span><span class="o">-</span><span class="n">lab</span>  <span class="n">normalbw</span>     <span class="n">R</span>      <span class="mi">1</span> <span class="mi">0</span> <span class="n">days</span> <span class="mi">00</span><span class="p">:</span><span class="mi">01</span><span class="p">:</span><span class="mi">18</span>  <span class="mi">0</span>     <span class="mi">14</span><span class="o">%</span>     <span class="mi">35</span><span class="o">%</span> <span class="mi">0</span> <span class="n">days</span> <span class="mi">00</span><span class="p">:</span><span class="mi">01</span><span class="p">:</span><span class="mi">00</span>
</pre></div>
</div>
<p>This is useful to check that your job is actually running in parallel - if the CPU percent is very low then it’s possible your job is running in serial mode</p>
</div>
<div class="section" id="example">
<h2>Example<a class="headerlink" href="#example" title="Permalink to this headline">¶</a></h2>
<p>Here’s a small example batch setup. You submit the job with <code class="docutils literal notranslate"><span class="pre">qsub</span> <span class="pre">submit_mean.pbs</span></code>, the batch script then runs the python script for you.</p>
<p><strong>submit_mean.pbs</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1">#PBS -l ncpus=4</span>
<span class="c1">#PBS -l mem=16gb</span>
<span class="c1">#PBS -l walltime=1:00:00</span>
<span class="c1">#PBS -l jobfs=100gb</span>
<span class="c1">#PBS -l wd</span>
<span class="c1">#PBS -l storage=gdata/hh5+gdata/rt52</span>
<span class="c1">#PBS -W umask=0022</span>
<span class="c1">#PBS -j oe</span>

module use /g/data3/hh5/public/modules
module load conda/analysis3-21.04

<span class="nb">set</span> -eu

python ./mean.py
</pre></div>
</div>
<p><strong>mean.py</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xarray</span>
<span class="kn">import</span> <span class="nn">climtas.nci</span>

<span class="c1"># It&#39;s fine to define functions outside of the `if __name__ == &#39;__main__&#39;` statement</span>
<span class="k">def</span> <span class="nf">calc_mean</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">variable</span><span class="p">):</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">xarray</span><span class="o">.</span><span class="n">open_mfdataset</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">combine</span><span class="o">=</span><span class="s1">&#39;nested&#39;</span><span class="p">,</span> <span class="n">concat_dim</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ds</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">climtas</span><span class="o">.</span><span class="n">nci</span><span class="o">.</span><span class="n">GadiClient</span><span class="p">()</span>
    
    <span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;/g/data/rt52/era5/single-levels/reanalysis/2t/2001/2t_era5_oper_sfc_*.nc&quot;</span>
    <span class="n">variable</span> <span class="o">=</span> <span class="s1">&#39;t2m&#39;</span>
    
    <span class="n">mean</span> <span class="o">=</span> <span class="n">calc_mean</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">variable</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">mean</span><span class="o">.</span><span class="n">load</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "conda-env-analysis3-py"
        },
        kernelOptions: {
            kernelName: "conda-env-analysis3-py",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'conda-env-analysis3-py'</script>

              </div>
              
        
        <div class='prev-next-bottom'>
            
    <a class='left-prev' id="prev-link" href="case-studies/read_speed.html" title="previous page">Measuring Performance</a>
    <a class='right-next' id="next-link" href="case-studies/oned_to_nd_rewrite.html" title="next page">Converting a function from 1D to ND - slice method</a>

        </div>
        
        </div>
    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By CLEX CMS<br/>
        
            &copy; Copyright 2020.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>