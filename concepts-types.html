
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Types of parallelism &#8212; Parallel Programming in Climate and Weather</title>
    
  <link href="_static/css/theme.css" rel="stylesheet" />
  <link href="_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/sphinx-book-theme.acff12b8f9c144ce68a297486a2fa670.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="_static/js/index.1c5a1a01449ed65a7b51.js">

    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/togglebutton.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Introduction" href="dask-intro.html" />
    <link rel="prev" title="Introduction" href="concepts-intro.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="index.html">
      
      
      <h1 class="site-logo" id="site-title">Parallel Programming in Climate and Weather</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="README.html">
   Front Matter
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Concepts
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="concepts-intro.html">
   Introduction
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Types of parallelism
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Dask
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="dask-intro.html">
   Introduction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="dask-performance.html">
   Performance
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="dask-troubleshooting.html">
   Pathological Behaviour and Troubleshooting
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="case-studies/read_speed.html">
   Measuring Performance
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Case Studies
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="case-studies/oned_to_nd.html">
   Converting a function from 1D to ND
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="case-studies/loading_ensemble.html">
   Loading Ensemble Members
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="_sources/concepts-types.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/coecms-training/parallel"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/coecms-training/parallel/master?urlpath=tree/concepts-types.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#embarissingly-parallel">
   Embarissingly Parallel
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#gnu-parallel">
     GNU Parallel
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#looped-qsub">
     Looped Qsub
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#vectorised-operators">
   Vectorised operators
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#fortran-c">
     Fortran / C
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#python">
     Python
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#distributed">
   Distributed
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#shared-memory">
   Shared Memory
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id1">
     Fortran / C
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#design-patterns">
   Design Patterns
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#common-gotchas">
   Common Gotchas
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#race-conditions">
     Race Conditions
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#locks">
     Locks
    </a>
   </li>
  </ul>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="types-of-parallelism">
<h1>Types of parallelism<a class="headerlink" href="#types-of-parallelism" title="Permalink to this headline">¶</a></h1>
<div class="section" id="embarissingly-parallel">
<h2>Embarissingly Parallel<a class="headerlink" href="#embarissingly-parallel" title="Permalink to this headline">¶</a></h2>
<p>The simplest method of parallelisation is ‘embarissingly parallel’ - this is a type of parallelisation that requires no extra effort.</p>
<p>Consider a program that takes in hourly data, producing daily means. Each day’s result is totally independent and requires no knowledge of what happens on the previous or subsequent day. If our input file is split up, say into one file per month, we can process each file independently, say with a loop:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> input <span class="k">in</span> tas_*.nc<span class="p">;</span> <span class="k">do</span>
    <span class="nv">output</span><span class="o">=</span>tas_daily_<span class="si">${</span><span class="nv">input</span><span class="p">#*_</span><span class="si">}</span> <span class="c1"># Changes tas_201001.nc to tas_daily_201001.nc</span>
    
    ./hourly_to_daily.py <span class="nv">$input</span> <span class="nv">$output</span>
<span class="k">done</span>
</pre></div>
</div>
<div class="section" id="gnu-parallel">
<h3>GNU Parallel<a class="headerlink" href="#gnu-parallel" title="Permalink to this headline">¶</a></h3>
<p>To parallelise this loop automatically you can use <a class="reference external" href="https://www.gnu.org/software/parallel/">GNU parallel</a> (module ‘parallel’ at NCI):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>parallel --jobs <span class="m">4</span> ./hourly_to_daily.py ::: tas_*.nc
</pre></div>
</div>
<p>This will run <code class="docutils literal notranslate"><span class="pre">./hourly_to_daily.py</span></code> on each of the files <code class="docutils literal notranslate"><span class="pre">tas_*.nc</span></code>, with at most 4 jobs running in parallel.</p>
<p>There’s a couple things to note - first we can’t do the fancy output file naming trick, the script itself would need to handle that. Secondly <code class="docutils literal notranslate"><span class="pre">parallel</span></code> can only use a single node if you’re using a supercomputer.</p>
</div>
<div class="section" id="looped-qsub">
<h3>Looped Qsub<a class="headerlink" href="#looped-qsub" title="Permalink to this headline">¶</a></h3>
<p>If you have access to a supercomputer you can also try submitting multiple jobs to its queue, using an environment variable to identify which file to process. Using Gadi’s qsub:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> input <span class="k">in</span> tas_*.nc<span class="p">;</span> <span class="k">do</span>
    qsub -v input hourly_to_daily.pbs
<span class="k">done</span>
</pre></div>
</div>
<p>with the job script</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1"># hourly_to_daily.pbs</span>
<span class="c1">#PBS -l ncpus=1,walltime=0:10:00,mem=4gb,wd</span>

<span class="nb">set</span> -eu
<span class="nv">output</span><span class="o">=</span>tas_daily_<span class="si">${</span><span class="nv">input</span><span class="p">#*_</span><span class="si">}</span> <span class="c1"># Changes tas_201001.nc to tas_daily_201001.nc</span>

./hourly_to_daily.py <span class="nv">$input</span> <span class="nv">$output</span>
</pre></div>
</div>
<p>You can also combine this with <code class="docutils literal notranslate"><span class="pre">parallel</span></code>, say by submitting a year at a time</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> year <span class="k">in</span> <span class="o">{</span><span class="m">1990</span>..2010<span class="o">}</span>
    qsub -v year hourly_to_daily_year.pbs
<span class="k">done</span>
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1"># hourly_to_daily_year.pbs</span>
<span class="c1">#PBS -l ncpus=4,walltime=0:10:00,mem=16gb,wd</span>

<span class="nb">set</span> -eu
module load parallel

parallel --jobs <span class="nv">$PBS_NCPUS</span> ./hourly_to_daily.py ::: tas_<span class="si">${</span><span class="nv">year</span><span class="si">}</span>*.nc
</pre></div>
</div>
</div>
</div>
<div class="section" id="vectorised-operators">
<h2>Vectorised operators<a class="headerlink" href="#vectorised-operators" title="Permalink to this headline">¶</a></h2>
<p>The next simplest parallelisation method to use is vectorisation. Modern computers have <a class="reference external" href="https://en.wikipedia.org/wiki/Advanced_Vector_Extensions">‘vector instruction sets’</a> that can compute multiple values in an array at once.</p>
<div class="section" id="fortran-c">
<h3>Fortran / C<a class="headerlink" href="#fortran-c" title="Permalink to this headline">¶</a></h3>
<p>If you’re using Fortran or C, this is for the most part automatic (assuming you’re compiling with the <code class="docutils literal notranslate"><span class="pre">-O2</span></code> or <code class="docutils literal notranslate"><span class="pre">-O3</span></code> flags to enable optimisations). It can be helpful to set the <code class="docutils literal notranslate"><span class="pre">-xHost</span></code> (intel) or <code class="docutils literal notranslate"><span class="pre">-march=native</span></code> (gnu) flag too - this lets the compiler use the full vector capability available on the CPU, but you can’t then run the program on a different CPU type without recompiling (At NCI, Gadi has different CPU types available in different queues).</p>
<p>It is also possible to work with the vector instructions directly, using <a class="reference external" href="https://software.intel.com/content/www/us/en/develop/documentation/get-started-with-mkl-for-dpcpp/top.html">Intel MKL</a> or compiler intrinsic functions. This should only be done by experienced programmers after detailled profiling of the code to ensure you’re working on a part of the program that’s actually slow.</p>
</div>
<div class="section" id="python">
<h3>Python<a class="headerlink" href="#python" title="Permalink to this headline">¶</a></h3>
<p>In Python the easiest way to use vectorisation is to use Numpy, or libraries that depend on it (scipy, pandas, xarray etc.). Numpy uses optimised functions when doing array operations.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>As much as possible avoid looping over elements of a numpy array, working on the whole array at once is much faster.</p>
</div>
</div>
</div>
<div class="section" id="distributed">
<h2>Distributed<a class="headerlink" href="#distributed" title="Permalink to this headline">¶</a></h2>
<p>Fortran:
MPI</p>
<p>Python:
Multiprocessing
Dask Distributed</p>
</div>
<div class="section" id="shared-memory">
<h2>Shared Memory<a class="headerlink" href="#shared-memory" title="Permalink to this headline">¶</a></h2>
<p>Perhaps the most complex of these options is shared memory parallelisation. In this model, all the processes have a shared view of arrays, and loops can be annotated to run in parallel. This saves on memory, as each process doesn’t need its own copy of data, but adds the complexity that writes need to be managed to avoid race conditions. Shared memory will also only work within a single node, if you’re wanting to use more than one node you can combine it with message passing so that all the processes on a single node share memory, and the nodes themselves pass messages between each other over MPI.</p>
<div class="section" id="id1">
<h3>Fortran / C<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>The most common library for shared memory parallelisation is <a class="reference external" href="https://www.openmp.org/">OpenMP</a>. This lets you annotate loops with special comments which will then be automatically paralellised. A special compiler flag <code class="docutils literal notranslate"><span class="pre">-qopenmp</span></code> (Intel) or <code class="docutils literal notranslate"><span class="pre">-openmp</span></code> (Gnu) is needed to enable OpenMP comments, and the environment variable <code class="docutils literal notranslate"><span class="pre">$OMP_NUM_THREADS</span></code> needs to be set to the number of processes the program will use.</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="kt">real</span> <span class="kd">::</span> <span class="n">a</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span> <span class="n">b</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span> <span class="n">c</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="kt">real</span> <span class="kd">::</span> <span class="n">d</span>
<span class="kt">integer</span> <span class="kd">::</span> <span class="n">i</span>

<span class="c">!$omp parallel loop private(d)</span>
<span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">a</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span>
    <span class="n">c</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">b</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="n">d</span>
<span class="k">end do</span>
</pre></div>
</div>
<p>Here all the loop iterations are run in parallel, with each instance running an iteration of the loop. The variable <code class="docutils literal notranslate"><span class="pre">d</span></code> is marked as private - every instance gets its own <code class="docutils literal notranslate"><span class="pre">d</span></code> variable. The arrays are shared, so each instance reads and writes to the same arrays.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>One thing to watch is to make sure each iteration of the loop is independent, as they can be executed in arbitrary order. Here <code class="docutils literal notranslate"><span class="pre">c(4)</span></code> might be evaluated before <code class="docutils literal notranslate"><span class="pre">c(3)</span></code> is, producing unexpected results</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="n">c</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span>
<span class="c">!$omp parallel loop</span>
<span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="mi">10</span>
    <span class="n">c</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
<span class="k">end do</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="design-patterns">
<h2>Design Patterns<a class="headerlink" href="#design-patterns" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="common-gotchas">
<h2>Common Gotchas<a class="headerlink" href="#common-gotchas" title="Permalink to this headline">¶</a></h2>
<div class="section" id="race-conditions">
<h3>Race Conditions<a class="headerlink" href="#race-conditions" title="Permalink to this headline">¶</a></h3>
</div>
<div class="section" id="locks">
<h3>Locks<a class="headerlink" href="#locks" title="Permalink to this headline">¶</a></h3>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "conda-env-analysis3-py"
        },
        kernelOptions: {
            kernelName: "conda-env-analysis3-py",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'conda-env-analysis3-py'</script>

              </div>
              
        
        <div class='prev-next-bottom'>
            
    <a class='left-prev' id="prev-link" href="concepts-intro.html" title="previous page">Introduction</a>
    <a class='right-next' id="next-link" href="dask-intro.html" title="next page">Introduction</a>

        </div>
        
        </div>
    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By CLEX CMS<br/>
        
            &copy; Copyright 2020.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>