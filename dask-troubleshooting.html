
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pathological Behaviour and Troubleshooting &#8212; Parallel Programming in Climate and Weather</title>
    
  <link href="_static/css/theme.css" rel="stylesheet" />
  <link href="_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/sphinx-book-theme.acff12b8f9c144ce68a297486a2fa670.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="_static/js/index.1c5a1a01449ed65a7b51.js">

    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/togglebutton.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Measuring Performance" href="case-studies/read_speed.html" />
    <link rel="prev" title="Performance" href="dask-performance.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="index.html">
      
      
      <h1 class="site-logo" id="site-title">Parallel Programming in Climate and Weather</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="README.html">
   Front Matter
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Concepts
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="concepts-intro.html">
   Introduction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="concepts-types.html">
   Types of parallelism
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Dask
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="dask-intro.html">
   Introduction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="dask-performance.html">
   Performance
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Pathological Behaviour and Troubleshooting
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="case-studies/read_speed.html">
   Measuring Performance
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Case Studies
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="case-studies/oned_to_nd.html">
   Converting a function from 1D to ND
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="case-studies/loading_ensemble.html">
   Loading Ensemble Members
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="_sources/dask-troubleshooting.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/coecms-training/parallel"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/coecms-training/parallel/master?urlpath=tree/dask-troubleshooting.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#indexing-using-an-array">
   Indexing using an array
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#climatologies-resampling">
   Climatologies &amp; Resampling
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#lack-of-backpressure">
   Lack of Backpressure
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#kernel-dying-out-of-memory">
   Kernel Dying / Out of Memory
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="pathological-behaviour-and-troubleshooting">
<h1>Pathological Behaviour and Troubleshooting<a class="headerlink" href="#pathological-behaviour-and-troubleshooting" title="Permalink to this headline">¶</a></h1>
<p>Some Dask operations can show really poor performance. Here are some workarounds that we have found</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This behaviour may not apply to all versions of Dask, it’s mostly to highlight areas where we’ve seen problems</p>
</div>
<div class="section" id="indexing-using-an-array">
<h2>Indexing using an array<a class="headerlink" href="#indexing-using-an-array" title="Permalink to this headline">¶</a></h2>
<p>Using an array of indices to index a Dask array can make Dask load the entire thing</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Return only the values at 0000Z</span>
<span class="n">indices</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">hour</span> <span class="o">==</span>  <span class="mi">0</span>

<span class="n">sample</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
</pre></div>
</div>
<p>Instead try <code class="docutils literal notranslate"><span class="pre">.where(...,</span> <span class="pre">drop=True)</span></code></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">sample</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">hour</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>Or alternatively, make sure the index array has the same chunking as the source data</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">indices</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isifinite</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="c1"># Computed from &#39;data&#39;, so has the same chunks</span>

<span class="n">sample</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="section" id="climatologies-resampling">
<h2>Climatologies &amp; Resampling<a class="headerlink" href="#climatologies-resampling" title="Permalink to this headline">¶</a></h2>
<p>The default Xarray climatology and resample operations create a large number of chunks - one for each sample period.</p>
<p>Say we want to resample hourly ERA5 data to daily</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xarray</span>

<span class="n">msl</span> <span class="o">=</span> <span class="n">xarray</span><span class="o">.</span><span class="n">open_mfdataset</span><span class="p">(</span><span class="s1">&#39;/g/data/rt52/era5/single-levels/reanalysis/msl/2010/*.nc&#39;</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;latitude&#39;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span> <span class="s1">&#39;longitude&#39;</span><span class="p">:</span> <span class="mi">300</span><span class="p">})</span><span class="o">.</span><span class="n">msl</span>
<span class="n">msl</span><span class="o">.</span><span class="n">data</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table>
<tr>
<td>
<table>
  <thead>
    <tr><td> </td><th> Array </th><th> Chunk </th></tr>
  </thead>
  <tbody>
    <tr><th> Bytes </th><td> 36.38 GB </td> <td> 267.84 MB </td></tr>
    <tr><th> Shape </th><td> (8760, 721, 1440) </td> <td> (744, 300, 300) </td></tr>
    <tr><th> Count </th><td> 372 Tasks </td><td> 180 Chunks </td></tr>
    <tr><th> Type </th><td> float32 </td><td> numpy.ndarray </td></tr>
  </tbody>
</table>
</td>
<td>
<svg width="171" height="158" style="stroke:rgb(0,0,0);stroke-width:1" >

  <!-- Horizontal lines -->
  <line x1="10" y1="0" x2="80" y2="70" style="stroke-width:2" />
  <line x1="10" y1="15" x2="80" y2="86" />
  <line x1="10" y1="31" x2="80" y2="101" />
  <line x1="10" y1="37" x2="80" y2="108" style="stroke-width:2" />

  <!-- Vertical lines -->
  <line x1="10" y1="0" x2="10" y2="37" style="stroke-width:2" />
  <line x1="15" y1="5" x2="15" y2="43" />
  <line x1="21" y1="11" x2="21" y2="48" />
  <line x1="27" y1="17" x2="27" y2="54" />
  <line x1="33" y1="23" x2="33" y2="60" />
  <line x1="39" y1="29" x2="39" y2="66" />
  <line x1="45" y1="35" x2="45" y2="72" />
  <line x1="50" y1="40" x2="50" y2="78" />
  <line x1="56" y1="46" x2="56" y2="84" />
  <line x1="62" y1="52" x2="62" y2="90" />
  <line x1="68" y1="58" x2="68" y2="96" />
  <line x1="74" y1="64" x2="74" y2="102" />
  <line x1="80" y1="70" x2="80" y2="108" style="stroke-width:2" />

  <!-- Colored Rectangle -->
  <polygon points="10.0,0.0 80.58823529411765,70.58823529411765 80.58823529411765,108.07999437241787 10.0,37.49175907830022" style="fill:#ECB172A0;stroke-width:0"/>

  <!-- Horizontal lines -->
  <line x1="10" y1="0" x2="51" y2="0" style="stroke-width:2" />
  <line x1="15" y1="5" x2="57" y2="5" />
  <line x1="21" y1="11" x2="62" y2="11" />
  <line x1="27" y1="17" x2="68" y2="17" />
  <line x1="33" y1="23" x2="74" y2="23" />
  <line x1="39" y1="29" x2="80" y2="29" />
  <line x1="45" y1="35" x2="86" y2="35" />
  <line x1="50" y1="40" x2="92" y2="40" />
  <line x1="56" y1="46" x2="98" y2="46" />
  <line x1="62" y1="52" x2="103" y2="52" />
  <line x1="68" y1="58" x2="109" y2="58" />
  <line x1="74" y1="64" x2="115" y2="64" />
  <line x1="80" y1="70" x2="121" y2="70" style="stroke-width:2" />

  <!-- Vertical lines -->
  <line x1="10" y1="0" x2="80" y2="70" style="stroke-width:2" />
  <line x1="18" y1="0" x2="89" y2="70" />
  <line x1="27" y1="0" x2="97" y2="70" />
  <line x1="35" y1="0" x2="106" y2="70" />
  <line x1="44" y1="0" x2="114" y2="70" />
  <line x1="51" y1="0" x2="121" y2="70" style="stroke-width:2" />

  <!-- Colored Rectangle -->
  <polygon points="10.0,0.0 51.13999720598501,0.0 121.72823250010266,70.58823529411765 80.58823529411765,70.58823529411765" style="fill:#ECB172A0;stroke-width:0"/>

  <!-- Horizontal lines -->
  <line x1="80" y1="70" x2="121" y2="70" style="stroke-width:2" />
  <line x1="80" y1="86" x2="121" y2="86" />
  <line x1="80" y1="101" x2="121" y2="101" />
  <line x1="80" y1="108" x2="121" y2="108" style="stroke-width:2" />

  <!-- Vertical lines -->
  <line x1="80" y1="70" x2="80" y2="108" style="stroke-width:2" />
  <line x1="89" y1="70" x2="89" y2="108" />
  <line x1="97" y1="70" x2="97" y2="108" />
  <line x1="106" y1="70" x2="106" y2="108" />
  <line x1="114" y1="70" x2="114" y2="108" />
  <line x1="121" y1="70" x2="121" y2="108" style="stroke-width:2" />

  <!-- Colored Rectangle -->
  <polygon points="80.58823529411765,70.58823529411765 121.72823250010266,70.58823529411765 121.72823250010266,108.07999437241787 80.58823529411765,108.07999437241787" style="fill:#ECB172A0;stroke-width:0"/>

  <!-- Text -->
  <text x="101.158234" y="128.079994" font-size="1.0rem" font-weight="100" text-anchor="middle" >1440</text>
  <text x="141.728233" y="89.334115" font-size="1.0rem" font-weight="100" text-anchor="middle" transform="rotate(-90,141.728233,89.334115)">721</text>
  <text x="35.294118" y="92.785877" font-size="1.0rem" font-weight="100" text-anchor="middle" transform="rotate(45,35.294118,92.785877)">8760</text>
</svg>
</td>
</tr>
</table></div></div>
</div>
<p>The source data has a reasonable chunk size - a month in time, and 300x300 horizontally, with a total of 180 chunks in the whole dataset.</p>
<p>Using the default Xarray resample increases the number of chunks dramatically</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">msl_daily</span> <span class="o">=</span> <span class="n">msl</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="s1">&#39;1D&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">msl_daily</span><span class="o">.</span><span class="n">data</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table>
<tr>
<td>
<table>
  <thead>
    <tr><td> </td><th> Array </th><th> Chunk </th></tr>
  </thead>
  <tbody>
    <tr><th> Bytes </th><td> 1.52 GB </td> <td> 360.00 kB </td></tr>
    <tr><th> Shape </th><td> (365, 721, 1440) </td> <td> (1, 300, 300) </td></tr>
    <tr><th> Count </th><td> 22272 Tasks </td><td> 5475 Chunks </td></tr>
    <tr><th> Type </th><td> float32 </td><td> numpy.ndarray </td></tr>
  </tbody>
</table>
</td>
<td>
<svg width="205" height="135" style="stroke:rgb(0,0,0);stroke-width:1" >

  <!-- Horizontal lines -->
  <line x1="10" y1="0" x2="35" y2="25" style="stroke-width:2" />
  <line x1="10" y1="25" x2="35" y2="50" />
  <line x1="10" y1="50" x2="35" y2="75" />
  <line x1="10" y1="60" x2="35" y2="85" style="stroke-width:2" />

  <!-- Vertical lines -->
  <line x1="10" y1="0" x2="10" y2="60" style="stroke-width:2" />
  <line x1="11" y1="1" x2="11" y2="61" />
  <line x1="12" y1="2" x2="12" y2="62" />
  <line x1="13" y1="3" x2="13" y2="64" />
  <line x1="15" y1="5" x2="15" y2="65" />
  <line x1="16" y1="6" x2="16" y2="66" />
  <line x1="17" y1="7" x2="17" y2="68" />
  <line x1="19" y1="9" x2="19" y2="69" />
  <line x1="20" y1="10" x2="20" y2="70" />
  <line x1="21" y1="11" x2="21" y2="71" />
  <line x1="23" y1="13" x2="23" y2="73" />
  <line x1="24" y1="14" x2="24" y2="74" />
  <line x1="25" y1="15" x2="25" y2="76" />
  <line x1="27" y1="17" x2="27" y2="77" />
  <line x1="28" y1="18" x2="28" y2="78" />
  <line x1="29" y1="19" x2="29" y2="80" />
  <line x1="31" y1="21" x2="31" y2="81" />
  <line x1="32" y1="22" x2="32" y2="82" />
  <line x1="33" y1="23" x2="33" y2="83" />
  <line x1="35" y1="25" x2="35" y2="85" style="stroke-width:2" />

  <!-- Colored Rectangle -->
  <polygon points="10.0,0.0 35.26481292860946,25.26481292860946 35.26481292860946,85.34814626194279 10.0,60.083333333333336" style="fill:#8B4903A0;stroke-width:0"/>

  <!-- Horizontal lines -->
  <line x1="10" y1="0" x2="130" y2="0" style="stroke-width:2" />
  <line x1="11" y1="1" x2="131" y2="1" />
  <line x1="12" y1="2" x2="132" y2="2" />
  <line x1="13" y1="3" x2="133" y2="3" />
  <line x1="15" y1="5" x2="135" y2="5" />
  <line x1="16" y1="6" x2="136" y2="6" />
  <line x1="17" y1="7" x2="137" y2="7" />
  <line x1="19" y1="9" x2="139" y2="9" />
  <line x1="20" y1="10" x2="140" y2="10" />
  <line x1="21" y1="11" x2="141" y2="11" />
  <line x1="23" y1="13" x2="143" y2="13" />
  <line x1="24" y1="14" x2="144" y2="14" />
  <line x1="25" y1="15" x2="145" y2="15" />
  <line x1="27" y1="17" x2="147" y2="17" />
  <line x1="28" y1="18" x2="148" y2="18" />
  <line x1="29" y1="19" x2="149" y2="19" />
  <line x1="31" y1="21" x2="151" y2="21" />
  <line x1="32" y1="22" x2="152" y2="22" />
  <line x1="33" y1="23" x2="153" y2="23" />
  <line x1="35" y1="25" x2="155" y2="25" style="stroke-width:2" />

  <!-- Vertical lines -->
  <line x1="10" y1="0" x2="35" y2="25" style="stroke-width:2" />
  <line x1="35" y1="0" x2="60" y2="25" />
  <line x1="60" y1="0" x2="85" y2="25" />
  <line x1="85" y1="0" x2="110" y2="25" />
  <line x1="110" y1="0" x2="135" y2="25" />
  <line x1="130" y1="0" x2="155" y2="25" style="stroke-width:2" />

  <!-- Colored Rectangle -->
  <polygon points="10.0,0.0 130.0,0.0 155.26481292860944,25.26481292860946 35.26481292860946,25.26481292860946" style="fill:#8B4903A0;stroke-width:0"/>

  <!-- Horizontal lines -->
  <line x1="35" y1="25" x2="155" y2="25" style="stroke-width:2" />
  <line x1="35" y1="50" x2="155" y2="50" />
  <line x1="35" y1="75" x2="155" y2="75" />
  <line x1="35" y1="85" x2="155" y2="85" style="stroke-width:2" />

  <!-- Vertical lines -->
  <line x1="35" y1="25" x2="35" y2="85" style="stroke-width:2" />
  <line x1="60" y1="25" x2="60" y2="85" />
  <line x1="85" y1="25" x2="85" y2="85" />
  <line x1="110" y1="25" x2="110" y2="85" />
  <line x1="135" y1="25" x2="135" y2="85" />
  <line x1="155" y1="25" x2="155" y2="85" style="stroke-width:2" />

  <!-- Colored Rectangle -->
  <polygon points="35.26481292860946,25.26481292860946 155.26481292860944,25.26481292860946 155.26481292860944,85.34814626194279 35.26481292860946,85.34814626194279" style="fill:#ECB172A0;stroke-width:0"/>

  <!-- Text -->
  <text x="95.264813" y="105.348146" font-size="1.0rem" font-weight="100" text-anchor="middle" >1440</text>
  <text x="175.264813" y="55.306480" font-size="1.0rem" font-weight="100" text-anchor="middle" transform="rotate(-90,175.264813,55.306480)">721</text>
  <text x="12.632406" y="92.715740" font-size="1.0rem" font-weight="100" text-anchor="middle" transform="rotate(45,12.632406,92.715740)">365</text>
</svg>
</td>
</tr>
</table></div></div>
</div>
<p>The number of chunks has increased by 30x, and the task graph size by 60x. Rather than one chunk per month, now the time chunking is once per day.</p>
<p>This increase in chunk count is neccessary if your data’s time axis is irregularly spaced, but if you have regular data it’s possible to optimise the resampling using array reshaping operations without changing the number of chunks.</p>
<p>The <a class="reference external" href="https://climtas.readthedocs.io">climtas</a> library has implementations of resample and groupby that implement these optimisations, keeping the number of chunks the same and not significantly increasing the task graph size.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">climtas</span>

<span class="n">msl_daily</span> <span class="o">=</span> <span class="n">climtas</span><span class="o">.</span><span class="n">blocked_resample</span><span class="p">(</span><span class="n">msl</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">msl_daily</span><span class="o">.</span><span class="n">data</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table>
<tr>
<td>
<table>
  <thead>
    <tr><td> </td><th> Array </th><th> Chunk </th></tr>
  </thead>
  <tbody>
    <tr><th> Bytes </th><td> 1.52 GB </td> <td> 11.16 MB </td></tr>
    <tr><th> Shape </th><td> (365, 721, 1440) </td> <td> (31, 300, 300) </td></tr>
    <tr><th> Count </th><td> 552 Tasks </td><td> 180 Chunks </td></tr>
    <tr><th> Type </th><td> float32 </td><td> numpy.ndarray </td></tr>
  </tbody>
</table>
</td>
<td>
<svg width="205" height="135" style="stroke:rgb(0,0,0);stroke-width:1" >

  <!-- Horizontal lines -->
  <line x1="10" y1="0" x2="35" y2="25" style="stroke-width:2" />
  <line x1="10" y1="25" x2="35" y2="50" />
  <line x1="10" y1="50" x2="35" y2="75" />
  <line x1="10" y1="60" x2="35" y2="85" style="stroke-width:2" />

  <!-- Vertical lines -->
  <line x1="10" y1="0" x2="10" y2="60" style="stroke-width:2" />
  <line x1="12" y1="2" x2="12" y2="62" />
  <line x1="14" y1="4" x2="14" y2="64" />
  <line x1="16" y1="6" x2="16" y2="66" />
  <line x1="18" y1="8" x2="18" y2="68" />
  <line x1="20" y1="10" x2="20" y2="70" />
  <line x1="22" y1="12" x2="22" y2="72" />
  <line x1="24" y1="14" x2="24" y2="74" />
  <line x1="26" y1="16" x2="26" y2="76" />
  <line x1="28" y1="18" x2="28" y2="78" />
  <line x1="31" y1="21" x2="31" y2="81" />
  <line x1="33" y1="23" x2="33" y2="83" />
  <line x1="35" y1="25" x2="35" y2="85" style="stroke-width:2" />

  <!-- Colored Rectangle -->
  <polygon points="10.0,0.0 35.26481292860946,25.26481292860946 35.26481292860946,85.34814626194279 10.0,60.083333333333336" style="fill:#ECB172A0;stroke-width:0"/>

  <!-- Horizontal lines -->
  <line x1="10" y1="0" x2="130" y2="0" style="stroke-width:2" />
  <line x1="12" y1="2" x2="132" y2="2" />
  <line x1="14" y1="4" x2="134" y2="4" />
  <line x1="16" y1="6" x2="136" y2="6" />
  <line x1="18" y1="8" x2="138" y2="8" />
  <line x1="20" y1="10" x2="140" y2="10" />
  <line x1="22" y1="12" x2="142" y2="12" />
  <line x1="24" y1="14" x2="144" y2="14" />
  <line x1="26" y1="16" x2="146" y2="16" />
  <line x1="28" y1="18" x2="148" y2="18" />
  <line x1="31" y1="21" x2="151" y2="21" />
  <line x1="33" y1="23" x2="153" y2="23" />
  <line x1="35" y1="25" x2="155" y2="25" style="stroke-width:2" />

  <!-- Vertical lines -->
  <line x1="10" y1="0" x2="35" y2="25" style="stroke-width:2" />
  <line x1="35" y1="0" x2="60" y2="25" />
  <line x1="60" y1="0" x2="85" y2="25" />
  <line x1="85" y1="0" x2="110" y2="25" />
  <line x1="110" y1="0" x2="135" y2="25" />
  <line x1="130" y1="0" x2="155" y2="25" style="stroke-width:2" />

  <!-- Colored Rectangle -->
  <polygon points="10.0,0.0 130.0,0.0 155.26481292860944,25.26481292860946 35.26481292860946,25.26481292860946" style="fill:#ECB172A0;stroke-width:0"/>

  <!-- Horizontal lines -->
  <line x1="35" y1="25" x2="155" y2="25" style="stroke-width:2" />
  <line x1="35" y1="50" x2="155" y2="50" />
  <line x1="35" y1="75" x2="155" y2="75" />
  <line x1="35" y1="85" x2="155" y2="85" style="stroke-width:2" />

  <!-- Vertical lines -->
  <line x1="35" y1="25" x2="35" y2="85" style="stroke-width:2" />
  <line x1="60" y1="25" x2="60" y2="85" />
  <line x1="85" y1="25" x2="85" y2="85" />
  <line x1="110" y1="25" x2="110" y2="85" />
  <line x1="135" y1="25" x2="135" y2="85" />
  <line x1="155" y1="25" x2="155" y2="85" style="stroke-width:2" />

  <!-- Colored Rectangle -->
  <polygon points="35.26481292860946,25.26481292860946 155.26481292860944,25.26481292860946 155.26481292860944,85.34814626194279 35.26481292860946,85.34814626194279" style="fill:#ECB172A0;stroke-width:0"/>

  <!-- Text -->
  <text x="95.264813" y="105.348146" font-size="1.0rem" font-weight="100" text-anchor="middle" >1440</text>
  <text x="175.264813" y="55.306480" font-size="1.0rem" font-weight="100" text-anchor="middle" transform="rotate(-90,175.264813,55.306480)">721</text>
  <text x="12.632406" y="92.715740" font-size="1.0rem" font-weight="100" text-anchor="middle" transform="rotate(45,12.632406,92.715740)">365</text>
</svg>
</td>
</tr>
</table></div></div>
</div>
</div>
<div class="section" id="lack-of-backpressure">
<h2>Lack of Backpressure<a class="headerlink" href="#lack-of-backpressure" title="Permalink to this headline">¶</a></h2>
<p>The Dask task graph doesn’t currently keep track of how much memory an operation will use. This means that Dask can try to start processing lots of chunks, but then as it goes down the graph it stalls as there isn’t enough memory available to perform the next set of operations.</p>
<p>The ideal way to solve this is to use a concept called ‘back pressure’ - the rate that new chunks start being processed is limited to make sure that there’s enough memory available to finish processing them. Dask doesn’t currently support this, as a work around the Climtas library has a function that will save a Dataset to file a few chunks at a time manually rate limiting the number of active chunks being processed.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">climtas</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">to_netcdf_throttled</span><span class="p">(</span><span class="n">msl_daily</span><span class="p">,</span> <span class="s1">&#39;era5_msl_daily.nc&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="kernel-dying-out-of-memory">
<h2>Kernel Dying / Out of Memory<a class="headerlink" href="#kernel-dying-out-of-memory" title="Permalink to this headline">¶</a></h2>
<p>The Jupyter kernel dying can be identified either as an explicit error message that pops up, or when you try to execute a cell and the number goes back to ‘[1]’</p>
<p>The most likely cause of the kernel dying is running out of memory. This can either be from Dask loading too much, keeping a lot of arrays around, or from external libraries like netCDF needing extra memory.</p>
<p>To see if Dask is loading too much memory, check the memory graph in the [Distributed Dashboard](distributed dashboard), and make sure your cluster’s memory limit matches the resources you have available. Dask will restart a worker if its memory goes over 90% or so of its limit.</p>
<p>If you use Numpy arrays to hold intermediate data, then it’s possible for the size of these arrays to add up to quite a lot, especially if they’re multi-dimensional. You can get the size of an array in bytes with <code class="docutils literal notranslate"><span class="pre">.nbytes</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">100</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">20</span><span class="p">))</span>
<span class="n">x</span><span class="o">.</span><span class="n">nbytes</span> <span class="o">/</span> <span class="mi">1024</span><span class="o">**</span><span class="mi">2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.52587890625
</pre></div>
</div>
</div>
</div>
<p>or by converting to a dask array and checking the dask printout:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">dask.array</span>

<span class="n">dask</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">from_array</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table>
<tr>
<td>
<table>
  <thead>
    <tr><td> </td><th> Array </th><th> Chunk </th></tr>
  </thead>
  <tbody>
    <tr><th> Bytes </th><td> 1.60 MB </td> <td> 1.60 MB </td></tr>
    <tr><th> Shape </th><td> (100, 100, 20) </td> <td> (100, 100, 20) </td></tr>
    <tr><th> Count </th><td> 1 Tasks </td><td> 1 Chunks </td></tr>
    <tr><th> Type </th><td> float64 </td><td> numpy.ndarray </td></tr>
  </tbody>
</table>
</td>
<td>
<svg width="172" height="240" style="stroke:rgb(0,0,0);stroke-width:1" >

  <!-- Horizontal lines -->
  <line x1="10" y1="0" x2="80" y2="70" style="stroke-width:2" />
  <line x1="10" y1="120" x2="80" y2="190" style="stroke-width:2" />

  <!-- Vertical lines -->
  <line x1="10" y1="0" x2="10" y2="120" style="stroke-width:2" />
  <line x1="80" y1="70" x2="80" y2="190" style="stroke-width:2" />

  <!-- Colored Rectangle -->
  <polygon points="10.0,0.0 80.58823529411765,70.58823529411765 80.58823529411765,190.58823529411765 10.0,120.0" style="fill:#ECB172A0;stroke-width:0"/>

  <!-- Horizontal lines -->
  <line x1="10" y1="0" x2="52" y2="0" style="stroke-width:2" />
  <line x1="80" y1="70" x2="122" y2="70" style="stroke-width:2" />

  <!-- Vertical lines -->
  <line x1="10" y1="0" x2="80" y2="70" style="stroke-width:2" />
  <line x1="52" y1="0" x2="122" y2="70" style="stroke-width:2" />

  <!-- Colored Rectangle -->
  <polygon points="10.0,0.0 52.00989029700999,0.0 122.59812559112764,70.58823529411765 80.58823529411765,70.58823529411765" style="fill:#ECB172A0;stroke-width:0"/>

  <!-- Horizontal lines -->
  <line x1="80" y1="70" x2="122" y2="70" style="stroke-width:2" />
  <line x1="80" y1="190" x2="122" y2="190" style="stroke-width:2" />

  <!-- Vertical lines -->
  <line x1="80" y1="70" x2="80" y2="190" style="stroke-width:2" />
  <line x1="122" y1="70" x2="122" y2="190" style="stroke-width:2" />

  <!-- Colored Rectangle -->
  <polygon points="80.58823529411765,70.58823529411765 122.59812559112764,70.58823529411765 122.59812559112764,190.58823529411765 80.58823529411765,190.58823529411765" style="fill:#ECB172A0;stroke-width:0"/>

  <!-- Text -->
  <text x="101.593180" y="210.588235" font-size="1.0rem" font-weight="100" text-anchor="middle" >20</text>
  <text x="142.598126" y="130.588235" font-size="1.0rem" font-weight="100" text-anchor="middle" transform="rotate(-90,142.598126,130.588235)">100</text>
  <text x="35.294118" y="175.294118" font-size="1.0rem" font-weight="100" text-anchor="middle" transform="rotate(45,35.294118,175.294118)">100</text>
</svg>
</td>
</tr>
</table></div></div>
</div>
<p>If you’re creating intermediate arrays in a loop then it can be helpful to create a function for the loop body, as that will ensure that the temporary arrays are cleaned up.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">process_var</span><span class="p">(</span><span class="n">var</span><span class="p">):</span>
    <span class="n">da</span> <span class="o">=</span> <span class="n">xarray</span><span class="o">.</span><span class="n">open_dataarray</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s1">.nc&#39;</span><span class="p">)</span>
    <span class="n">temp</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="p">(</span><span class="n">da</span> <span class="o">+</span> <span class="n">temp</span><span class="p">)</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s1">_rand.nc&#39;</span><span class="p">)</span>
    <span class="c1"># &#39;da&#39; and &#39;temp&#39; get cleaned up when the function exits</span>

<span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">]:</span>
    <span class="n">process_var</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
</pre></div>
</div>
<p>Another issue we have seen is from the NetCDF library not having enough memory available to decompress the data it reads from a file. NetCDF itself needs some memory available in order to open a file, so you need to leave some space for that in your Dask allocation. This needn’t be a massive amount, a hundred megabytes or so should be fine.</p>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "conda-env-analysis3-py"
        },
        kernelOptions: {
            kernelName: "conda-env-analysis3-py",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'conda-env-analysis3-py'</script>

              </div>
              
        
        <div class='prev-next-bottom'>
            
    <a class='left-prev' id="prev-link" href="dask-performance.html" title="previous page">Performance</a>
    <a class='right-next' id="next-link" href="case-studies/read_speed.html" title="next page">Measuring Performance</a>

        </div>
        
        </div>
    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By CLEX CMS<br/>
        
            &copy; Copyright 2020.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>